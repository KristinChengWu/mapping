
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>scanning.coordinates &#8212; mapping  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for scanning.coordinates</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">pi</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">tan</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">radians</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">root_scalar</span>
<span class="kn">from</span> <span class="nn">astropy.time</span> <span class="kn">import</span> <span class="n">Time</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>

<span class="kn">from</span> <span class="nn">scanning</span> <span class="kn">import</span> <span class="n">FYST_LOC</span><span class="p">,</span> <span class="n">_central_diff</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">specify units when passing in x, y</span>
<span class="sd">azimuth in terms of east from north </span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">##################</span>
<span class="c1">#  SKY PATTERN </span>
<span class="c1">##################</span>

<span class="k">class</span> <span class="nc">SkyPattern</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Representing the path of the center of a detector array in terms of offsets. &quot;&quot;&quot;</span>

    <span class="c1"># other attributes (for development)</span>
    <span class="c1"># _stored_units</span>
    <span class="c1"># _data: time_offset, x_coord, y_coord</span>
    <span class="c1"># _param, _param_units</span>
    <span class="c1"># _sample_interval</span>
    <span class="c1"># _repeatable</span>

    <span class="n">_param_units</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;num_repeat&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span><span class="p">}</span>
    <span class="n">_stored_units</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;time_offset&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;x_coord&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="s1">&#39;y_coord&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">repeatable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        --------------------------------</span>
<span class="sd">        data : str, DataFrame, or [dict of str -&gt; sequence]</span>
<span class="sd">            If `str`, a file path to a csv file. If `dict` or `DataFrame`, column names map to their values. </span>
<span class="sd">            Must have columns &#39;time_offset&#39;, &#39;x_coord&#39;, &#39;y_coord&#39;.</span>
<span class="sd">        repeatable : bool; default False</span>
<span class="sd">            Whether this pattern can repeat itself (ends where it starts).</span>
<span class="sd">        units : [dict of str -&gt; str or Unit] or None; default None</span>
<span class="sd">            Mapping columns in `data` with their units. All columns do not need to be mapped.</span>
<span class="sd">            If not provided, all angle-like units are assumed to be in degrees and all time-like units are assumed to be in seconds.</span>
<span class="sd">        </span>
<span class="sd">        Keyword Args</span>
<span class="sd">        ---------------------------------</span>
<span class="sd">        num_repeat : int; default 1 </span>
<span class="sd">            Number of repeats of the pattern. Must be a positive integer.</span>
<span class="sd">            Cannot be used with `max_scan_duration` and `repeatable` must be `True`.</span>
<span class="sd">        max_scan_duration : float/Quantity/str; default unit sec</span>
<span class="sd">            Maximum total scan time to determine number of repeats. Must be positive. </span>
<span class="sd">            Cannot be used with `num_repeat` and `repeatable` must be `True`.</span>

<span class="sd">        Raises</span>
<span class="sd">        -----------------------------------</span>
<span class="sd">        ValueError</span>
<span class="sd">            &quot;data&quot; could not be parsed</span>
<span class="sd">        ValueError</span>
<span class="sd">            sample interval must be constant</span>

<span class="sd">        Examples</span>
<span class="sd">        -----------------------------</span>
<span class="sd">        &gt;&gt;&gt; # if x_coord is specifically in arcseconds</span>
<span class="sd">        &gt;&gt;&gt; SkyPattern(&#39;file.csv&#39;, units={&#39;x_coord&#39;: &#39;arcsec&#39;})</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_repeatable</span> <span class="o">=</span> <span class="n">repeatable</span> 

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time_offset&#39;</span><span class="p">,</span> <span class="s1">&#39;x_coord&#39;</span><span class="p">,</span> <span class="s1">&#39;y_coord&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)[[</span><span class="s1">&#39;time_offset&#39;</span><span class="p">,</span> <span class="s1">&#39;x_coord&#39;</span><span class="p">,</span> <span class="s1">&#39;y_coord&#39;</span><span class="p">]]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;data&#39; could not be parsed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># convert to specified units</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stored_units</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>

        <span class="c1"># determine sample_interval </span>
        <span class="n">sample_interval_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;time_offset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">sample_interval_list</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sample_interval_list</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.01</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sample_interval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sample_interval_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;sample interval must be constant&#39;</span><span class="p">)</span>

        <span class="c1"># repeating the scan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_param</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeat_scan</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># INITIALIZATION</span>

    <span class="k">def</span> <span class="nf">_clean_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwarg_keys</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="c1"># determine number of repeats</span>
        <span class="k">if</span> <span class="s1">&#39;max_scan_duration&#39;</span> <span class="ow">in</span> <span class="n">kwarg_keys</span> <span class="ow">or</span> <span class="s1">&#39;num_repeat&#39;</span> <span class="ow">in</span> <span class="n">kwarg_keys</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">repeatable</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;This is not a repeatable pattern, but you have indicated to repeat it. This may or may not repeat.&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="s1">&#39;max_scan_duration&#39;</span> <span class="ow">in</span> <span class="n">kwarg_keys</span> <span class="ow">and</span> <span class="s1">&#39;num_repeat&#39;</span> <span class="ow">in</span> <span class="n">kwarg_keys</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;&quot;max_scan_duration&quot; and &quot;num_repeat&quot; cannot be inputted together&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;max_scan_duration&#39;</span> <span class="ow">in</span> <span class="n">kwarg_keys</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;num_repeat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">nan</span> <span class="c1"># set as null for now, will determine once first pattern is generated</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;max_scan_duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;max_scan_duration&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stored_units</span><span class="p">[</span><span class="s1">&#39;time_offset&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;num_repeat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_repeat&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">kwargs</span>

    <span class="k">def</span> <span class="nf">_repeat_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">one_scan_duration</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;time_offset&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_interval</span><span class="o">.</span><span class="n">value</span>

        <span class="n">num_repeat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_repeat&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># determine number of repeats</span>
        <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">num_repeat</span><span class="p">):</span>
            <span class="n">max_scan_duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;max_scan_duration&#39;</span><span class="p">)</span> <span class="c1"># only store number of repeats, not maximum scan duration</span>
            <span class="n">num_repeat</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">max_scan_duration</span><span class="o">/</span><span class="n">one_scan_duration</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_param</span><span class="p">[</span><span class="s1">&#39;num_repeat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_repeat</span>

        <span class="c1"># repeat pattern if necessary </span>
        <span class="k">if</span> <span class="n">num_repeat</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;number of repeats = </span><span class="si">{</span><span class="n">num_repeat</span><span class="si">}</span><span class="s1"> is less than 1&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">num_repeat</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;You have chosen to repeat this pattern. However, analytic patterns </span><span class="se">\</span>
<span class="s1">            (such as Pong) may not have their next location in the repeat be exactly their first original location </span><span class="se">\</span>
<span class="s1">            to ensure a constant time interval. This may cause spikes in higher derivates. Mitigate this by </span><span class="se">\</span>
<span class="s1">            initializing this object with its intended subclass using its original parameters.&#39;</span><span class="p">)</span>

            <span class="n">time_offset</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;time_offset&#39;</span><span class="p">]</span>
            <span class="n">x_coord</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;x_coord&#39;</span><span class="p">]</span>
            <span class="n">y_coord</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;y_coord&#39;</span><span class="p">]</span>
            <span class="n">data_temp</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_repeat</span><span class="p">):</span>
                <span class="n">data_temp</span><span class="p">[</span><span class="s1">&#39;time_offset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_offset</span> <span class="o">+</span> <span class="n">one_scan_duration</span><span class="o">*</span><span class="n">i</span>
                <span class="n">data_temp</span><span class="p">[</span><span class="s1">&#39;x_coord&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_coord</span>
                <span class="n">data_temp</span><span class="p">[</span><span class="s1">&#39;y_coord&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_coord</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_temp</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>

    <span class="c1"># OBJECT DATA</span>

    <span class="k">def</span> <span class="nf">save_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_or_buf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">include_repeats</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------------------</span>
<span class="sd">        path_or_buf : str, file handle or None; default None</span>
<span class="sd">            File path or object, if `None` is provided the result is returned as a dictionary.</span>
<span class="sd">        columns : sequence, str or [dict of str -&gt; str/Unit/None]; default &#39;default&#39;</span>
<span class="sd">            Columns to write. If `dict`, map column names to their desired unit and use `None` if you would like to use the standard (deg for angle-like units, sec for time-like units).</span>
<span class="sd">            &#39;default&#39; for [&#39;time_offset&#39;, &#39;x_coord&#39;, &#39;y_coord&#39;]</span>
<span class="sd">            &#39;all&#39; for [&#39;time_offset&#39;, &#39;x_coord&#39;, &#39;y_coord&#39;, &#39;distance&#39;, &#39;x_vel&#39;, &#39;y_vel&#39;, &#39;vel&#39;, &#39;x_acc&#39;, &#39;y_acc&#39;, &#39;acc&#39;, &#39;x_jerk&#39;, &#39;y_jerk&#39;, &#39;jerk&#39;]</span>
<span class="sd">        include_repeats : bool, default &#39;True&#39;</span>
<span class="sd">            Whether to include repeats of the SkyPattern.</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------------------</span>
<span class="sd">        None or [dict of str -&gt; array]</span>
<span class="sd">            If `path_or_buf` is `None`, returns the data as a dictionary mapping column name to values. Otherwise returns `None`.</span>

<span class="sd">        Examples</span>
<span class="sd">        ---------------------</span>
<span class="sd">        &gt;&gt;&gt; skypattern.save_data(&#39;file.csv&#39;, columns={&#39;time_offset&#39;: &#39;sec&#39;, &#39;x_coord&#39;: &#39;arcsec&#39;, &#39;y_coord&#39;: None})</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># replace str options</span>
        <span class="k">if</span> <span class="n">columns</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;time_offset&#39;</span><span class="p">,</span> <span class="s1">&#39;x_coord&#39;</span><span class="p">,</span> <span class="s1">&#39;y_coord&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">columns</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;time_offset&#39;</span><span class="p">,</span> <span class="s1">&#39;x_coord&#39;</span><span class="p">,</span> <span class="s1">&#39;y_coord&#39;</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">,</span> <span class="s1">&#39;x_vel&#39;</span><span class="p">,</span> <span class="s1">&#39;y_vel&#39;</span><span class="p">,</span> <span class="s1">&#39;vel&#39;</span><span class="p">,</span> <span class="s1">&#39;x_acc&#39;</span><span class="p">,</span> <span class="s1">&#39;y_acc&#39;</span><span class="p">,</span> <span class="s1">&#39;acc&#39;</span><span class="p">,</span> <span class="s1">&#39;x_jerk&#39;</span><span class="p">,</span> <span class="s1">&#39;y_jerk&#39;</span><span class="p">,</span> <span class="s1">&#39;jerk&#39;</span><span class="p">]</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="c1"># generate required data</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">columns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">unit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

        <span class="c1"># whether to include repetitions </span>
        <span class="n">num_repeat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_repeat&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">include_repeats</span> <span class="ow">and</span> <span class="n">num_repeat</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">before_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">/</span><span class="n">num_repeat</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">before_index</span><span class="p">]</span>
        
        <span class="c1"># returning</span>
        <span class="k">if</span> <span class="n">path_or_buf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">path_or_buf</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_or_buf</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------------------------</span>
<span class="sd">        path_or_buf : str, file handle, or None; default None</span>
<span class="sd">            File path or object, if `None` is provided the result is returned as a dictionary.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        ----------------------</span>
<span class="sd">        None or [dict of str -&gt; numeric]</span>
<span class="sd">            If `path_or_buf` is `None`, returns the resulting json format as a dictionary. Otherwise returns `None`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">param_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># save param_json</span>
        <span class="k">if</span> <span class="n">path_or_buf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">param_temp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_or_buf</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">param_temp</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="c1"># PROPERTIES</span>
    
    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="c1"># for easy access of properties without unit conversions</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span>
            <span class="n">prop</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span> <span class="ow">is</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">prop</span><span class="o">.</span><span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">prop</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;type object &quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot; has no attribute &quot;</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">repeatable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;bool: Whether this pattern is repeatable or not.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeatable</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">param</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;dict of str -&gt; (float or Quantity): Parameters inputted by user.&quot;&quot;&quot;</span>
        <span class="n">return_param</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">return_param</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_units</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="ow">is</span> <span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span> <span class="k">else</span> <span class="n">val</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_param_units</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">return_param</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sample_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Quantity: Time interval between samples.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_interval</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_stored_units</span><span class="p">[</span><span class="s1">&#39;time_offset&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">scan_duration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Quantity: Total scan duration.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_offset</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_interval</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">time_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Quantity array: Time offsets.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s1">&#39;time_offset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_stored_units</span><span class="p">[</span><span class="s1">&#39;time_offset&#39;</span><span class="p">]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x_coord</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Quantity array: x positions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s1">&#39;x_coord&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_stored_units</span><span class="p">[</span><span class="s1">&#39;x_coord&#39;</span><span class="p">]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">y_coord</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Quantity array: y positions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s1">&#39;y_coord&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_stored_units</span><span class="p">[</span><span class="s1">&#39;y_coord&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">distance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Quantity array: Distance of points from the center.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_coord</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_coord</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x_vel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Quantity array: x velocity.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_central_diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_coord</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_interval</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stored_units</span><span class="p">[</span><span class="s1">&#39;x_coord&#39;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_stored_units</span><span class="p">[</span><span class="s1">&#39;time_offset&#39;</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">y_vel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Quantity array: y velocity.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_central_diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_coord</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_interval</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stored_units</span><span class="p">[</span><span class="s1">&#39;y_coord&#39;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_stored_units</span><span class="p">[</span><span class="s1">&#39;time_offset&#39;</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Quantity array: Total velocity.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_vel</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_vel</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x_acc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Quantity array: x acceleration.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_central_diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_vel</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_interval</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stored_units</span><span class="p">[</span><span class="s1">&#39;x_coord&#39;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_stored_units</span><span class="p">[</span><span class="s1">&#39;time_offset&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">y_acc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Quantity array: y acceleration.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_central_diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_vel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_interval</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stored_units</span><span class="p">[</span><span class="s1">&#39;y_coord&#39;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_stored_units</span><span class="p">[</span><span class="s1">&#39;time_offset&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">acc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Quantity array: Total acceleration.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_acc</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_acc</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x_jerk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Quantity array: x jerk.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_central_diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_acc</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_interval</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stored_units</span><span class="p">[</span><span class="s1">&#39;x_coord&#39;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_stored_units</span><span class="p">[</span><span class="s1">&#39;time_offset&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">y_jerk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Quantity array: y jerk.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_central_diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_acc</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_interval</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stored_units</span><span class="p">[</span><span class="s1">&#39;y_coord&#39;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_stored_units</span><span class="p">[</span><span class="s1">&#39;time_offset&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">jerk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Quantity array: Total jerk.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_jerk</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_jerk</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<div class="viewcode-block" id="Pong"><a class="viewcode-back" href="../../intro.html#scanning.coordinates.Pong">[docs]</a><span class="k">class</span> <span class="nc">Pong</span><span class="p">(</span><span class="n">SkyPattern</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Curvy Pong pattern allows for an approximation of a Pong pattern while avoiding </span>
<span class="sd">    sharp turnarounds at the vertices. The Pong pattern is an analytic and close-pathed </span>
<span class="sd">    pattern that is optimized for regions a few square degrees. It makes a path that </span>
<span class="sd">    intends to cover each area uniformly and ends where it starts.</span>
<span class="sd">    </span>
<span class="sd">    See &quot;The Impact of Scanning Pattern Strategies on Uniform Sky Coverage of Large Maps&quot; </span>
<span class="sd">    (SCUBA Project SC2/ANA/S210/008) for details of implementation. </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_repeatable</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">_param_units</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;num_term&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span><span class="p">,</span>
        <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="s1">&#39;spacing&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
        <span class="s1">&#39;velocity&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;angle&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="s1">&#39;sample_interval&#39;</span><span class="p">:</span> <span class="n">SkyPattern</span><span class="o">.</span><span class="n">_stored_units</span><span class="p">[</span><span class="s1">&#39;time_offset&#39;</span><span class="p">],</span> 
        <span class="s1">&#39;num_repeat&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span>
    <span class="p">}</span>

<div class="viewcode-block" id="Pong.__init__"><a class="viewcode-back" href="../../intro.html#scanning.coordinates.Pong.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_json</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a Pong pattern by passing a parameter file and overwriting any parameters with **kwargs:</span>
<span class="sd">            option1 : Pong(param_json, **kwargs) </span>
<span class="sd">        or building from scratch: </span>
<span class="sd">            option2 : Pong(**kwargs)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ---------------------------</span>
<span class="sd">        param_json : str or None</span>
<span class="sd">            If `str` path to JSON file containing parameters. </span>
<span class="sd">        </span>
<span class="sd">        Keyword Args</span>
<span class="sd">        ----------------------------</span>
<span class="sd">        num_term : int</span>
<span class="sd">            Number of terms in the triangle wave expansion. Must be positive. </span>
<span class="sd">        width, height : float or Quantity or str; default unit deg</span>
<span class="sd">            Width and height of field of view. Must be positive. </span>
<span class="sd">        spacing : float or Quantity or str; default unit deg</span>
<span class="sd">            Space between adjacent (parallel) scan lines in the Pong pattern. Must be positive.</span>
<span class="sd">        velocity : float or Quantity or str; default unit deg/s</span>
<span class="sd">            Target magnitude of the total scan velocity excluding turn-arounds.</span>
<span class="sd">            NOTE this is now the total velocity, not just the velocity of one direction.</span>

<span class="sd">        angle : float or Quantity or str; default 0; default unit deg</span>
<span class="sd">            Position angle of the box in the native coordinate system. </span>
<span class="sd">        sample_interval : float or Quantity or str; default 1/400, default unit s</span>
<span class="sd">            Time between read-outs. Must be positive.</span>
<span class="sd">        num_repeat : int; default 1 </span>
<span class="sd">            Number of repeats of the pattern. Must be a positive integer.</span>
<span class="sd">            Cannot be used with `max_scan_duration`.</span>
<span class="sd">        max_scan_duration : float or Quantity or str; default unit sec</span>
<span class="sd">            Maximum total scan time to determine number of repeats. Must be positive. </span>
<span class="sd">            Cannot be used with `num_repeat`.</span>
<span class="sd">        </span>
<span class="sd">        Examples</span>
<span class="sd">        ---------------------------</span>
<span class="sd">        &gt;&gt;&gt; import astropy.units as u</span>
<span class="sd">        &gt;&gt;&gt; Pong(num_term=4, width=2, height=7200*u.arcsec, spacing=&#39;500 arcsec&#39;, velocity=1/2)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># pass kwargs</span>
        <span class="k">if</span> <span class="n">param_json</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_param</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># pass parameters by json</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">param_json</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">param</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
           
            <span class="c1"># overwrite any parameters</span>
            <span class="k">if</span> <span class="s1">&#39;max_scan_duration&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">param</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;num_repeat&#39;</span><span class="p">)</span>
            <span class="n">param</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_param</span><span class="p">(</span><span class="o">**</span><span class="n">param</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_sample_interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param</span><span class="p">[</span><span class="s1">&#39;sample_interval&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_scan</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_clean_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_clean_param</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;num_term&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;num_term&#39;</span><span class="p">])</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_units</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">value</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_units</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">value</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;spacing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;spacing&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_units</span><span class="p">[</span><span class="s1">&#39;spacing&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">value</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;velocity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;velocity&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_units</span><span class="p">[</span><span class="s1">&#39;velocity&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">value</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;angle&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_units</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">value</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sample_interval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sample_interval&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">400</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_units</span><span class="p">[</span><span class="s1">&#39;sample_interval&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">value</span>
        <span class="k">return</span> <span class="n">kwargs</span>

    <span class="k">def</span> <span class="nf">_generate_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="c1"># unpack parameters</span>
        <span class="n">num_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param</span><span class="p">[</span><span class="s1">&#39;num_term&#39;</span><span class="p">]</span>
        <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span>
        <span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span>
        <span class="n">spacing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param</span><span class="p">[</span><span class="s1">&#39;spacing&#39;</span><span class="p">]</span>
        <span class="n">velocity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param</span><span class="p">[</span><span class="s1">&#39;velocity&#39;</span><span class="p">]</span>
        <span class="n">sample_interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param</span><span class="p">[</span><span class="s1">&#39;sample_interval&#39;</span><span class="p">]</span>

        <span class="n">angle_rad</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_param</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">])</span>

        <span class="c1"># --- START OF ALGORITHM ---</span>

        <span class="c1"># Determine number of vertices (reflection points) along each side of the</span>
        <span class="c1"># box which satisfies the common-factors criterion and the requested size / spacing    </span>

        <span class="n">vert_spacing</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">spacing</span>
        <span class="n">x_numvert</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">width</span><span class="o">/</span><span class="n">vert_spacing</span><span class="p">)</span>
        <span class="n">y_numvert</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">height</span><span class="o">/</span><span class="n">vert_spacing</span><span class="p">)</span>
 
        <span class="k">if</span> <span class="n">x_numvert</span><span class="o">%</span><span class="mi">2</span> <span class="o">==</span> <span class="n">y_numvert</span><span class="o">%</span><span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x_numvert</span> <span class="o">&gt;=</span> <span class="n">y_numvert</span><span class="p">:</span>
                <span class="n">y_numvert</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x_numvert</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">num_vert</span> <span class="o">=</span> <span class="p">[</span><span class="n">x_numvert</span><span class="p">,</span> <span class="n">y_numvert</span><span class="p">]</span>
        <span class="n">most_i</span> <span class="o">=</span> <span class="n">num_vert</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">x_numvert</span><span class="p">,</span> <span class="n">y_numvert</span><span class="p">))</span>
        <span class="n">least_i</span> <span class="o">=</span> <span class="n">num_vert</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">x_numvert</span><span class="p">,</span> <span class="n">y_numvert</span><span class="p">))</span>

        <span class="k">while</span> <span class="n">math</span><span class="o">.</span><span class="n">gcd</span><span class="p">(</span><span class="n">num_vert</span><span class="p">[</span><span class="n">most_i</span><span class="p">],</span> <span class="n">num_vert</span><span class="p">[</span><span class="n">least_i</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">num_vert</span><span class="p">[</span><span class="n">most_i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span>
        
        <span class="n">x_numvert</span> <span class="o">=</span> <span class="n">num_vert</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_numvert</span> <span class="o">=</span> <span class="n">num_vert</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">gcd</span><span class="p">(</span><span class="n">x_numvert</span><span class="p">,</span> <span class="n">y_numvert</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">((</span><span class="n">x_numvert</span><span class="o">%</span><span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">y_numvert</span><span class="o">%</span><span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">x_numvert</span><span class="o">%</span><span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">y_numvert</span><span class="o">%</span><span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>

        <span class="c1"># Calculate the approximate periods by assuming a Pong scan with</span>
        <span class="c1"># no rounding at the corners. Average the x- and y-velocities</span>
        <span class="c1"># in order to determine the period in each direction, and the</span>
        <span class="c1"># total time required for the scan.</span>

        <span class="n">vavg</span> <span class="o">=</span> <span class="n">velocity</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># changed so velocity is TOTAL velocity and vavg is single-direction velocity</span>
        <span class="n">peri_x</span> <span class="o">=</span> <span class="n">x_numvert</span> <span class="o">*</span> <span class="n">vert_spacing</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">vavg</span>
        <span class="n">peri_y</span> <span class="o">=</span> <span class="n">y_numvert</span> <span class="o">*</span> <span class="n">vert_spacing</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">vavg</span>
        <span class="n">period</span> <span class="o">=</span> <span class="n">x_numvert</span> <span class="o">*</span> <span class="n">y_numvert</span> <span class="o">*</span> <span class="n">vert_spacing</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">vavg</span>

        <span class="n">amp_x</span> <span class="o">=</span> <span class="n">x_numvert</span> <span class="o">*</span> <span class="n">vert_spacing</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">amp_y</span> <span class="o">=</span> <span class="n">y_numvert</span> <span class="o">*</span> <span class="n">vert_spacing</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="c1"># Determine number of repeats</span>
        <span class="n">num_repeat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_repeat&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">num_repeat</span><span class="p">):</span>
            <span class="n">max_scan_duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;max_scan_duration&#39;</span><span class="p">)</span> <span class="c1"># only store number of repeats, not maximum scan duration</span>
            <span class="n">num_repeat</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">max_scan_duration</span><span class="o">/</span><span class="n">period</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_param</span><span class="p">[</span><span class="s1">&#39;num_repeat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_repeat</span>

        <span class="n">pongcount</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">period</span><span class="o">/</span><span class="n">sample_interval</span><span class="p">)</span><span class="o">*</span><span class="n">num_repeat</span> 
        
        <span class="c1"># Calculate the grid positions and apply rotation angle. Load</span>
        <span class="c1"># data into a dataframe.    </span>

        <span class="n">t_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">time_offset</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">x_coord</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">y_coord</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pongcount</span><span class="p">):</span>
            <span class="n">x_coord1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fourier_expansion</span><span class="p">(</span><span class="n">num_term</span><span class="p">,</span> <span class="n">amp_x</span><span class="p">,</span> <span class="n">t_count</span><span class="p">,</span> <span class="n">peri_x</span><span class="p">)</span>
            <span class="n">y_coord1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fourier_expansion</span><span class="p">(</span><span class="n">num_term</span><span class="p">,</span> <span class="n">amp_y</span><span class="p">,</span> <span class="n">t_count</span><span class="p">,</span> <span class="n">peri_y</span><span class="p">)</span>

            <span class="n">x_coord</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_coord1</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">angle_rad</span><span class="p">)</span> <span class="o">-</span> <span class="n">y_coord1</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">angle_rad</span><span class="p">))</span>
            <span class="n">y_coord</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_coord1</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">angle_rad</span><span class="p">)</span> <span class="o">+</span> <span class="n">y_coord1</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">angle_rad</span><span class="p">))</span>
            <span class="n">time_offset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t_count</span><span class="p">)</span>
            <span class="n">t_count</span> <span class="o">+=</span> <span class="n">sample_interval</span>
        
        <span class="c1"># repeat pattern if necessary </span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;time_offset&#39;</span><span class="p">:</span> <span class="n">time_offset</span><span class="p">,</span> 
            <span class="s1">&#39;x_coord&#39;</span><span class="p">:</span> <span class="n">x_coord</span><span class="p">,</span> <span class="s1">&#39;y_coord&#39;</span><span class="p">:</span> <span class="n">y_coord</span><span class="p">,</span>
        <span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">_fourier_expansion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_term</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">t_count</span><span class="p">,</span> <span class="n">peri</span><span class="p">):</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">num_term</span><span class="o">*</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">amp</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">peri</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">n</span><span class="o">**</span><span class="mi">2</span> 
            <span class="n">pos</span> <span class="o">+=</span> <span class="n">c</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">n</span><span class="o">*</span><span class="n">t_count</span><span class="p">)</span>

        <span class="n">pos</span> <span class="o">*=</span> <span class="n">a</span>
        <span class="k">return</span> <span class="n">pos</span></div>

<span class="k">class</span> <span class="nc">Daisy</span><span class="p">(</span><span class="n">SkyPattern</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Daisy pattern is optimized for point sources and works by having the path of the camera module </span>
<span class="sd">    move at constant velocity and cross the center of the map at various angles.</span>

<span class="sd">    See &quot;CV Daisy - JCMT small area scanning pattern&quot; (JCMT TCS/UN/005) for details of implementation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_param_units</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;velocity&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;start_acc&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> 
        <span class="s1">&#39;R0&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="s1">&#39;Rt&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="s1">&#39;Ra&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
        <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;sample_interval&#39;</span><span class="p">:</span> <span class="n">SkyPattern</span><span class="o">.</span><span class="n">_stored_units</span><span class="p">[</span><span class="s1">&#39;time_offset&#39;</span><span class="p">],</span> <span class="s1">&#39;y_offset&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
    <span class="p">}</span>
    <span class="n">_repeatable</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_json</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a Daisy pattern by passing a parameter file and overwriting any parameters with **kwargs:</span>
<span class="sd">            option1 : Daisy(param_json, **kwargs) </span>
<span class="sd">        or building from scratch: </span>
<span class="sd">            option2 : Daisy(**kwargs)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ---------------------------</span>
<span class="sd">        param_json : str or None</span>
<span class="sd">            If `str` path to JSON file containing parameters. </span>
<span class="sd">        </span>
<span class="sd">        Keyword Args</span>
<span class="sd">        ----------------------------</span>
<span class="sd">        velocity : float or Quanity or str; default unit deg/s</span>
<span class="sd">            Constant velocity (CV) for scan to go at. </span>
<span class="sd">        start_acc : float or Quanity or str; default unit deg/s^2</span>
<span class="sd">            Acceleration at start of pattern. Cannot be 0. </span>
<span class="sd">        R0 : float or Quanity or str; default unit deg</span>
<span class="sd">            Radius R0. Must be positive.</span>
<span class="sd">        Rt : float or Quanity or str; default unit deg</span>
<span class="sd">            Turn radius. Must be positive.</span>
<span class="sd">        Ra : float or Quanity or str; default unit deg</span>
<span class="sd">            Avoidance radius. Must be non-negative. </span>
<span class="sd">        T : float or Quanity or str; default unit sec</span>
<span class="sd">            Total time of the simulation. Must be postivie. </span>
<span class="sd">        sample_interval : float or Quanity or str; default 1/400, default unit sec</span>
<span class="sd">            Time step. </span>
<span class="sd">        y_offset : float or Quanity or str; default 0, default unit deg</span>
<span class="sd">            Start offset in y. </span>

<span class="sd">        Examples</span>
<span class="sd">        ----------------------------</span>
<span class="sd">        &gt;&gt;&gt; import astropy.units as u</span>
<span class="sd">        &gt;&gt;&gt; Daisy(velocity=1/3*u.deg/u.s, start_acc=&#39;0.2 deg/s/s&#39;, R0=0.47, Rt=800*u.arcsec, Ra=&#39;600 arcsec&#39;, T=300)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># pass kwargs</span>
        <span class="k">if</span> <span class="n">param_json</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_param</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># pass parameters by json</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">param_json</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">param</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
           
            <span class="c1"># overwrite any parameters</span>
            <span class="n">param</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_param</span><span class="p">(</span><span class="o">**</span><span class="n">param</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_sample_interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param</span><span class="p">[</span><span class="s1">&#39;sample_interval&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_scan</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_clean_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;velocity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;velocity&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_units</span><span class="p">[</span><span class="s1">&#39;velocity&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">value</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;start_acc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;start_acc&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_units</span><span class="p">[</span><span class="s1">&#39;start_acc&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">value</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;R0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;R0&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_units</span><span class="p">[</span><span class="s1">&#39;R0&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">value</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;Rt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;Rt&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_units</span><span class="p">[</span><span class="s1">&#39;Rt&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">value</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;Ra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;Ra&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_units</span><span class="p">[</span><span class="s1">&#39;Ra&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">value</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_units</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">value</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sample_interval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sample_interval&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">400</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_units</span><span class="p">[</span><span class="s1">&#39;sample_interval&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">value</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;y_offset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;y_offset&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_units</span><span class="p">[</span><span class="s1">&#39;y_offset&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">value</span>
        <span class="k">return</span> <span class="n">kwargs</span>
        
    <span class="k">def</span> <span class="nf">_generate_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># unpack parameters</span>
        <span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span>

        <span class="n">speed</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;velocity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">start_acc</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;start_acc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">R0</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;R0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">Rt</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;Rt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">Ra</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;Ra&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;sample_interval&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">y_offset</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;y_offset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

        <span class="c1"># If the sample rate is too low, sample at a higher frequency </span>
        <span class="c1"># and then only take a subset. </span>

        <span class="n">good_dt</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">150</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dt</span> <span class="o">&gt;</span> <span class="n">good_dt</span><span class="p">):</span>
            <span class="n">sample_every</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">dt</span><span class="o">/</span><span class="n">good_dt</span><span class="p">)</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="o">/</span><span class="n">sample_every</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sample_every</span> <span class="o">=</span> <span class="mi">1</span>

            
        <span class="c1"># --- START OF ALGORITHM ---</span>

        <span class="c1"># Tangent vector &amp; start value</span>
        <span class="p">(</span><span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> 

        <span class="c1"># Position vector &amp; start value</span>
        <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">y_offset</span><span class="p">)</span> 

        <span class="c1"># number of steps </span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">T</span><span class="o">/</span><span class="n">dt</span><span class="p">)</span>

        <span class="c1"># x, y arrays for storage</span>
        <span class="n">x_coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="n">y_coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="c1">#x_vel = np.empty(N)</span>
        <span class="c1">#y_vel = np.empty(N)</span>
        <span class="n">test</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Effective avoidance radius so Ra is not used if Ra &gt; R0 </span>
        <span class="c1">#R1 = min(R0, Ra) </span>

        <span class="n">s0</span> <span class="o">=</span> <span class="n">speed</span> 
        <span class="n">speed</span> <span class="o">=</span> <span class="mi">0</span> 
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span> 

            <span class="c1"># Ramp up speed with acceleration start_acc </span>
            <span class="c1"># to limit startup transients. Telescope has zero speed at startup. </span>
            <span class="n">speed</span> <span class="o">+=</span> <span class="n">start_acc</span><span class="o">*</span><span class="n">dt</span> 
            <span class="k">if</span> <span class="n">speed</span> <span class="o">&gt;=</span> <span class="n">s0</span><span class="p">:</span> 
                <span class="n">speed</span> <span class="o">=</span> <span class="n">s0</span> 

            <span class="n">r</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="p">)</span> 

            <span class="c1"># Straight motion inside R0 </span>
            <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">R0</span><span class="p">:</span> 
                <span class="n">x</span> <span class="o">+=</span> <span class="n">vx</span><span class="o">*</span><span class="n">speed</span><span class="o">*</span><span class="n">dt</span> 
                <span class="n">y</span> <span class="o">+=</span> <span class="n">vy</span><span class="o">*</span><span class="n">speed</span><span class="o">*</span><span class="n">dt</span> 

            <span class="c1"># Motion outside R0</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="p">(</span><span class="n">xn</span><span class="p">,</span><span class="n">yn</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">r</span><span class="p">,</span><span class="n">y</span><span class="o">/</span><span class="n">r</span><span class="p">)</span> <span class="c1"># Compute unit radial vector </span>

                <span class="c1"># If aiming close to center, resume straight motion</span>
                <span class="c1"># seems to only apply for the initial large turn </span>
                <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="n">xn</span><span class="o">*</span><span class="n">vx</span> <span class="o">-</span> <span class="n">yn</span><span class="o">*</span><span class="n">vy</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">Ra</span><span class="o">*</span><span class="n">Ra</span><span class="o">/</span><span class="n">r</span><span class="o">/</span><span class="n">r</span><span class="p">):</span> <span class="c1">#if (-xn*vx - yn*vy) &gt; 1/sqrt(1 + (Ra/r)**2):</span>
                    <span class="n">x</span> <span class="o">+=</span> <span class="n">vx</span><span class="o">*</span><span class="n">speed</span><span class="o">*</span><span class="n">dt</span> 
                    <span class="n">y</span> <span class="o">+=</span> <span class="n">vy</span><span class="o">*</span><span class="n">speed</span><span class="o">*</span><span class="n">dt</span> 

                <span class="c1"># Otherwise decide turning direction</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="n">xn</span><span class="o">*</span><span class="n">vy</span> <span class="o">+</span> <span class="n">yn</span><span class="o">*</span><span class="n">vx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> 
                        <span class="n">Nx</span> <span class="o">=</span> <span class="n">vy</span> 
                        <span class="n">Ny</span> <span class="o">=</span> <span class="o">-</span><span class="n">vx</span> 
                    <span class="k">else</span><span class="p">:</span> 
                        <span class="n">Nx</span> <span class="o">=</span> <span class="o">-</span><span class="n">vy</span> 
                        <span class="n">Ny</span> <span class="o">=</span> <span class="n">vx</span> 

                    <span class="c1"># Compute curved trajectory using serial exansion in step length s </span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">speed</span><span class="o">*</span><span class="n">dt</span> 
                    <span class="n">x</span> <span class="o">+=</span> <span class="p">(</span><span class="n">s</span> <span class="o">-</span> <span class="n">s</span><span class="o">*</span><span class="n">s</span><span class="o">*</span><span class="n">s</span><span class="o">/</span><span class="n">Rt</span><span class="o">/</span><span class="n">Rt</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">vx</span> <span class="o">+</span> <span class="n">s</span><span class="o">*</span><span class="n">s</span><span class="o">/</span><span class="n">Rt</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">Nx</span> 
                    <span class="n">y</span> <span class="o">+=</span> <span class="p">(</span><span class="n">s</span> <span class="o">-</span> <span class="n">s</span><span class="o">*</span><span class="n">s</span><span class="o">*</span><span class="n">s</span><span class="o">/</span><span class="n">Rt</span><span class="o">/</span><span class="n">Rt</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">vy</span> <span class="o">+</span> <span class="n">s</span><span class="o">*</span><span class="n">s</span><span class="o">/</span><span class="n">Rt</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">Ny</span> 
                    <span class="n">vx</span> <span class="o">+=</span> <span class="o">-</span><span class="n">s</span><span class="o">*</span><span class="n">s</span><span class="o">/</span><span class="n">Rt</span><span class="o">/</span><span class="n">Rt</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">vx</span> <span class="o">+</span> <span class="p">(</span><span class="n">s</span><span class="o">/</span><span class="n">Rt</span> <span class="o">+</span> <span class="n">s</span><span class="o">*</span><span class="n">s</span><span class="o">*</span><span class="n">s</span><span class="o">/</span><span class="n">Rt</span><span class="o">/</span><span class="n">Rt</span><span class="o">/</span><span class="n">Rt</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">Nx</span> 
                    <span class="n">vy</span> <span class="o">+=</span> <span class="o">-</span><span class="n">s</span><span class="o">*</span><span class="n">s</span><span class="o">/</span><span class="n">Rt</span><span class="o">/</span><span class="n">Rt</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">vy</span> <span class="o">+</span> <span class="p">(</span><span class="n">s</span><span class="o">/</span><span class="n">Rt</span> <span class="o">+</span> <span class="n">s</span><span class="o">*</span><span class="n">s</span><span class="o">*</span><span class="n">s</span><span class="o">/</span><span class="n">Rt</span><span class="o">/</span><span class="n">Rt</span><span class="o">/</span><span class="n">Rt</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">Ny</span> 

                    <span class="c1"># NOTE converting back into a unit vector, for long interations, the Daisy pattern starts spiraling out otherwise</span>
                    <span class="n">total_v</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">vx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">vy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">vx</span> <span class="o">=</span> <span class="n">vx</span><span class="o">/</span><span class="n">total_v</span>
                    <span class="n">vy</span> <span class="o">=</span> <span class="n">vy</span><span class="o">/</span><span class="n">total_v</span>

                    <span class="n">test</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">vy</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

            <span class="c1"># Store result for plotting and statistics</span>
            <span class="n">x_coord</span><span class="p">[</span><span class="n">step</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
            <span class="n">y_coord</span><span class="p">[</span><span class="n">step</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
            <span class="c1">#x_vel[step] = speed*vx</span>
            <span class="c1">#y_vel[step] = speed*vy</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ax = -2*xval[1: -1] + xval[0:-2] + xval[2:] # numerical acc in x </span>
<span class="sd">        ay = -2*yval[1: -1] + yval[0:-2] + yval[2:] # numerical acc in y </span>
<span class="sd">        x_acc = np.append(np.array([0]), ax/dt/dt)</span>
<span class="sd">        y_acc = np.append(np.array([0]), ay/dt/dt)</span>
<span class="sd">        x_acc = np.append(x_acc, 0)</span>
<span class="sd">        y_acc = np.append(y_acc, 0)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># check if pattern has spiraled</span>
        <span class="n">total_R</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">R0</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">Rt</span><span class="o">*</span><span class="n">Ra</span> <span class="o">+</span> <span class="n">Rt</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">Rt</span>
        <span class="n">last_R</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">x_coord</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y_coord</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">last_R</span> <span class="o">&gt;=</span> <span class="n">total_R</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">Rt</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;This Daisy scan may have spiraled out.&#39;</span><span class="p">)</span>

        <span class="c1"># return data</span>
        <span class="n">data</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;time_offset&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">dt</span><span class="p">),</span> 
            <span class="s1">&#39;x_coord&#39;</span><span class="p">:</span> <span class="n">x_coord</span><span class="o">/</span><span class="mi">3600</span><span class="p">,</span> <span class="s1">&#39;y_coord&#39;</span><span class="p">:</span> <span class="n">y_coord</span><span class="o">/</span><span class="mi">3600</span><span class="p">,</span> 
        <span class="p">})</span>

        <span class="k">if</span> <span class="n">sample_every</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[::</span><span class="n">sample_every</span><span class="p">,</span> <span class="p">:]</span>
 
<span class="c1">#######################</span>
<span class="c1">#  TELESCOPE PATTERN </span>
<span class="c1">#######################</span>

<span class="k">class</span> <span class="nc">TelescopePattern</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Representing the path in AZ/EL coordinates of the telescope&#39;s boresight.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_param_unit</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;start_ra&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="s1">&#39;start_dec&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
        <span class="s1">&#39;start_hrang&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> 
        <span class="s1">&#39;start_datetime&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span><span class="p">,</span> 
        <span class="s1">&#39;start_lst&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span>
        <span class="s1">&#39;start_elev&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="s1">&#39;moving_up&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span>
    <span class="p">}</span>
    <span class="n">_data_unit</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;time_offset&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;lst&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="s1">&#39;alt_coord&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="s1">&#39;az_coord&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">&#39;boresight&#39;</span><span class="p">,</span> <span class="n">obs_param</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the motion of the telescope.</span>
<span class="sd">            option1: data (sky), instrument (optional), module (optional); lat, start_ra, start_dec, (start_datetime or start_hrang or start_lst or [start_elev and moving_up])</span>
<span class="sd">            option2: data (telescope, excludes lst), instrument (optional), module (optional); lat, (start_ra or start_datetime or start_lst)</span>
<span class="sd">            option3: data (telescope, includes lst), instrument (optional), module (optional); lat</span>
<span class="sd">            **kwargs can be passed as a file through obs_param</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------------------------</span>
<span class="sd">        data : str or dict or SkyPattern</span>
<span class="sd">            Path to a csv file or a dict containing columns &#39;time_offset, &#39;az_coord&#39;, and &#39;alt_coord&#39;.</span>
<span class="sd">            If &#39;lst&#39; is included as a column, certain observation parameters are not required (see options).</span>
<span class="sd">            Path to SkyPattern object with time_offset, x_coord, y_coord.</span>

<span class="sd">        instrument : str, Instrument or None, default None</span>
<span class="sd">            Path to a json file or an Instrument object to be used if any.</span>
<span class="sd">        module : str or (distance, theta), default &#39;boresight&#39;</span>
<span class="sd">            Location relative to the center of the instrument where observation parameters are applied:</span>
<span class="sd">                &#39;boresight&#39; for boresight of the telescope </span>
<span class="sd">                string indicating a module name in the instrument e.g. &#39;SFH&#39; or one of the default slots in the instrument e.g. &#39;c&#39;, &#39;i1&#39;</span>
<span class="sd">                tuple of (distance, theta) indicating module&#39;s offset from the center of the instrument, default unit deg</span>

<span class="sd">        obs_param : str</span>
<span class="sd">            File path to json containing all required obervation parameters (see **kwargs).</span>

<span class="sd">        **kwargs</span>
<span class="sd">        start_ra : angle-like, default unit deg</span>
<span class="sd">            Starting right acension of telescope / right acension offset for sky.</span>
<span class="sd">        start_dec : angle-like, default unit deg</span>
<span class="sd">            Declination offset for sky_pattern.</span>
<span class="sd">        lat : angle-like, default unit deg, default FYST_LOC.lat</span>
<span class="sd">            Latitude of observation. </span>

<span class="sd">        start_datetime : str or datetime, default timezone UTC</span>
<span class="sd">            Starting date and time of observation.</span>
<span class="sd">        start_hrang : angle-like, default unit hourangle</span>
<span class="sd">            Starting hour angle of source.</span>
<span class="sd">        start_lst : angle-like, default unit hourangle</span>
<span class="sd">            Starting local sidereal time.</span>
<span class="sd">        start_elev : angle-like, default unit deg</span>
<span class="sd">            Starting elevation of source, must be used with moving_up</span>
<span class="sd">        moving_up : bool, default True</span>
<span class="sd">            whether observation is moving towards the meridian or away, must be used with start_elev. </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># --- Observation Parameters ---</span>

        <span class="c1"># pass by obs_param</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obs_param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">obs_param</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">param</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

            <span class="c1"># overwrite parameters FIXME start_</span>
            <span class="n">param</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">kwargs</span>

        <span class="c1"># --- sky_pattern or data ---</span>

        <span class="c1"># sky_pattern has been passed</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">SkyPattern</span><span class="p">):</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_param_sky_pattern</span><span class="p">(</span><span class="o">**</span><span class="n">param</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_sample_interval</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sample_interval</span><span class="o">.</span><span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;time_offset&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">time_offset</span><span class="o">.</span><span class="n">value</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;lst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lst</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">az1</span><span class="p">,</span> <span class="n">alt1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_sky_pattern</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;az_coord&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">az1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;alt_coord&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alt1</span>

        <span class="c1"># data has been passed</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time_offset&#39;</span><span class="p">,</span> <span class="s1">&#39;lst&#39;</span><span class="p">,</span> <span class="s1">&#39;az_coord&#39;</span><span class="p">,</span> <span class="s1">&#39;alt_coord&#39;</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_param_telescope_data</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">param</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time_offset&#39;</span><span class="p">,</span> <span class="s1">&#39;az_coord&#39;</span><span class="p">,</span> <span class="s1">&#39;alt_coord&#39;</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_param_telescope_data</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">param</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;lst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lst</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)[[</span><span class="s1">&#39;time_offset&#39;</span><span class="p">,</span> <span class="s1">&#39;lst&#39;</span><span class="p">,</span> <span class="s1">&#39;az_coord&#39;</span><span class="p">,</span> <span class="s1">&#39;alt_coord&#39;</span><span class="p">]]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_param_telescope_data</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">param</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)[[</span><span class="s1">&#39;time_offset&#39;</span><span class="p">,</span> <span class="s1">&#39;az_coord&#39;</span><span class="p">,</span> <span class="s1">&#39;alt_coord&#39;</span><span class="p">]]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_param_telescope_data</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">param</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;lst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lst</span><span class="p">()</span>

            <span class="c1"># determine sample_interval </span>
            <span class="n">sample_interval_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">time_offset</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">sample_interval_list</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sample_interval_list</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.01</span><span class="p">:</span>
                <span class="n">sample_interval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sample_interval_list</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sample_interval</span> <span class="o">=</span> <span class="n">sample_interval</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;sample_interval must be constant&#39;</span><span class="p">)</span>

        <span class="c1"># --- Instrument and module --- </span>

        <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span> <span class="o">=</span> <span class="n">instrument</span>
        <span class="n">dist</span><span class="p">,</span> <span class="n">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_true_module_loc</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
        
        <span class="c1"># az_coord and alt_coord are for the module&#39;s location</span>
        <span class="c1"># we need the az/alt coordinates of the boresight</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">module</span> <span class="o">==</span> <span class="s1">&#39;boresight&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="mi">0</span><span class="p">))):</span>
            <span class="n">az0</span><span class="p">,</span> <span class="n">alt0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_to_boresight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;az_coord&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;alt_coord&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">dist</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;az_coord&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">az0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;alt_coord&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alt0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;az_coord&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_angle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">az_coord</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alt_coord</span><span class="o">.</span><span class="n">value</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">alt_coord</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alt_coord</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">)])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;elevation has values outside of 0 to 90 range&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alt_coord</span><span class="o">.</span><span class="n">value</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">alt_coord</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alt_coord</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">75</span><span class="p">)])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;elevation has values outside of 30 to 75 range&#39;</span><span class="p">)</span>

    <span class="c1"># INITIALIZATION</span>

    <span class="k">def</span> <span class="nf">_clean_param_sky_pattern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwarg_keys</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">new_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># required</span>
        <span class="n">new_kwargs</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="n">FYST_LOC</span><span class="o">.</span><span class="n">lat</span><span class="p">),</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">new_kwargs</span><span class="p">[</span><span class="s1">&#39;start_ra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;start_ra&#39;</span><span class="p">),</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">new_kwargs</span><span class="p">[</span><span class="s1">&#39;start_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;start_dec&#39;</span><span class="p">),</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

        <span class="c1"># choose between</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span> <span class="p">[</span><span class="s1">&#39;start_hrang&#39;</span> <span class="ow">in</span> <span class="n">kwarg_keys</span><span class="p">,</span> <span class="s1">&#39;start_datetime&#39;</span> <span class="ow">in</span> <span class="n">kwarg_keys</span><span class="p">,</span> <span class="s1">&#39;start_lst&#39;</span> <span class="ow">in</span> <span class="n">kwarg_keys</span><span class="p">,</span> <span class="s1">&#39;start_elev&#39;</span> <span class="ow">in</span> <span class="n">kwarg_keys</span><span class="p">]</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;need one (and only one) of start_datetime, start_hrang, start_lst, or start_elev&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;start_hrang&#39;</span> <span class="ow">in</span> <span class="n">kwarg_keys</span><span class="p">:</span>
            <span class="n">new_kwargs</span><span class="p">[</span><span class="s1">&#39;start_hrang&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;start_hrang&#39;</span><span class="p">),</span> <span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">elif</span> <span class="s1">&#39;start_datetime&#39;</span> <span class="ow">in</span> <span class="n">kwarg_keys</span><span class="p">:</span>
            <span class="n">new_kwargs</span><span class="p">[</span><span class="s1">&#39;start_datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;start_datetime&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span>
        <span class="k">elif</span> <span class="s1">&#39;start_lst&#39;</span> <span class="ow">in</span> <span class="n">kwarg_keys</span><span class="p">:</span>
            <span class="n">new_kwargs</span><span class="p">[</span><span class="s1">&#39;start_lst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;start_lst&#39;</span><span class="p">),</span> <span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">elif</span> <span class="s1">&#39;start_elev&#39;</span> <span class="ow">in</span> <span class="n">kwarg_keys</span><span class="p">:</span>
            <span class="n">new_kwargs</span><span class="p">[</span><span class="s1">&#39;start_elev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;start_elev&#39;</span><span class="p">),</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="n">new_kwargs</span><span class="p">[</span><span class="s1">&#39;moving_up&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;moving_up&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unrecognized observation parameters: </span><span class="si">{</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">new_kwargs</span>

    <span class="k">def</span> <span class="nf">_clean_param_telescope_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">need_lst</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwarg_keys</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">new_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># required</span>
        <span class="n">new_kwargs</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="n">FYST_LOC</span><span class="o">.</span><span class="n">lat</span><span class="p">),</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

        <span class="k">if</span> <span class="n">need_lst</span><span class="p">:</span>

            <span class="c1"># choose between</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span> <span class="p">[</span><span class="s1">&#39;start_ra&#39;</span> <span class="ow">in</span> <span class="n">kwarg_keys</span><span class="p">,</span> <span class="s1">&#39;start_datetime&#39;</span> <span class="ow">in</span> <span class="n">kwarg_keys</span><span class="p">,</span> <span class="s1">&#39;start_lst&#39;</span> <span class="ow">in</span> <span class="n">kwarg_keys</span><span class="p">]</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;need one (and only one) of start_ra, start_datetime, or start_lst&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;start_ra&#39;</span> <span class="ow">in</span> <span class="n">kwarg_keys</span><span class="p">:</span>
                <span class="n">new_kwargs</span><span class="p">[</span><span class="s1">&#39;start_ra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;start_ra&#39;</span><span class="p">),</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="k">elif</span> <span class="s1">&#39;start_datetime&#39;</span> <span class="ow">in</span> <span class="n">kwarg_keys</span><span class="p">:</span>
                <span class="n">new_kwargs</span><span class="p">[</span><span class="s1">&#39;start_datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;start_datetime&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span>
            <span class="k">elif</span> <span class="s1">&#39;start_lst&#39;</span> <span class="ow">in</span> <span class="n">kwarg_keys</span><span class="p">:</span>
                <span class="n">new_kwargs</span><span class="p">[</span><span class="s1">&#39;start_lst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;start_lst&#39;</span><span class="p">),</span> <span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unrecognized observation parameters: </span><span class="si">{</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">new_kwargs</span>

    <span class="k">def</span> <span class="nf">_get_lst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sky_pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sky_pattern</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">extra_ra_offset</span> <span class="o">=</span> <span class="n">sky_pattern</span><span class="o">.</span><span class="n">x_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">extra_dec_offset</span> <span class="o">=</span> <span class="n">sky_pattern</span><span class="o">.</span><span class="n">y_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">extra_ra_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span>
            <span class="n">extra_dec_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span>

        <span class="c1"># given a starting datetime</span>
        <span class="k">if</span> <span class="s1">&#39;start_datetime&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">start_datetime</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_datetime</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="mi">0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
            <span class="n">start_lst</span> <span class="o">=</span> <span class="n">start_datetime</span><span class="o">.</span><span class="n">sidereal_time</span><span class="p">(</span><span class="s1">&#39;apparent&#39;</span><span class="p">)</span>

        <span class="c1"># given a starting hourangle</span>
        <span class="k">elif</span> <span class="s1">&#39;start_hrang&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sky_pattern</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">start_lst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_hrang</span> <span class="o">+</span> <span class="n">extra_ra_offset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_ra</span>
        
        <span class="c1"># given a starting lst</span>
        <span class="k">elif</span> <span class="s1">&#39;start_lst&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">start_lst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_lst</span>

        <span class="c1"># given a starting elevation</span>
        <span class="k">elif</span> <span class="s1">&#39;start_elev&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sky_pattern</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="c1"># determine possible hour angles</span>
            <span class="n">alt_rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_elev</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="n">dec_rad</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_dec</span> <span class="o">+</span> <span class="n">extra_dec_offset</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="n">lat_rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">start_hrang_rad</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">acos</span><span class="p">((</span><span class="n">sin</span><span class="p">(</span><span class="n">alt_rad</span><span class="p">)</span> <span class="o">-</span> <span class="n">sin</span><span class="p">(</span><span class="n">dec_rad</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">lat_rad</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">dec_rad</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">lat_rad</span><span class="p">)))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">max_el</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">asin</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">dec_rad</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">lat_rad</span><span class="p">)</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="n">dec_rad</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">lat_rad</span><span class="p">))))</span>
                <span class="n">min_el</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">asin</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">dec_rad</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">lat_rad</span><span class="p">)</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="n">dec_rad</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">lat_rad</span><span class="p">))))</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Elevation = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">start_elev</span><span class="si">}</span><span class="s1"> is not possible at provided ra, dec, and latitude. Min elevation is </span><span class="si">{</span><span class="n">min_el</span><span class="si">}</span><span class="s1"> and max elevation is </span><span class="si">{</span><span class="n">max_el</span><span class="si">}</span><span class="s1"> deg.&#39;</span><span class="p">)</span>

            <span class="c1"># choose hour angle</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">moving_up</span><span class="p">:</span>
                <span class="n">start_hrang_rad</span> <span class="o">=</span> <span class="o">-</span><span class="n">start_hrang_rad</span>

            <span class="c1"># starting sidereal time</span>
            <span class="n">start_lst</span> <span class="o">=</span> <span class="n">start_hrang_rad</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span> <span class="o">+</span> <span class="n">extra_ra_offset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_ra</span>
        
        <span class="k">elif</span> <span class="s1">&#39;start_ra&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">sky_pattern</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lat_rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="n">alt_rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="n">az_rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">az_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

            <span class="n">dec_rad</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">asin</span><span class="p">(</span> <span class="n">sin</span><span class="p">(</span><span class="n">lat_rad</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">alt_rad</span><span class="p">)</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">lat_rad</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">alt_rad</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">az_rad</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">hrang_rad</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">acos</span><span class="p">(</span> <span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">alt_rad</span><span class="p">)</span> <span class="o">-</span> <span class="n">sin</span><span class="p">(</span><span class="n">dec_rad</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">lat_rad</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">dec_rad</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">lat_rad</span><span class="p">))</span> <span class="p">)</span>

            <span class="k">if</span> <span class="n">sin</span><span class="p">(</span><span class="n">az_rad</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">hrang_rad</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span> <span class="o">-</span> <span class="n">hrang_rad</span>

            <span class="n">start_lst</span> <span class="o">=</span> <span class="n">hrang_rad</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_ra</span>

        <span class="c1"># find sidereal time</span>
        <span class="n">SIDEREAL_TO_UT1</span> <span class="o">=</span> <span class="mf">1.002737909350795</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_offset</span><span class="o">.</span><span class="n">value</span><span class="o">/</span><span class="mi">3600</span><span class="o">*</span><span class="n">SIDEREAL_TO_UT1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">hourangle</span> <span class="o">+</span> <span class="n">start_lst</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span> <span class="nf">_from_sky_pattern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sky_pattern</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">sky_pattern</span><span class="o">.</span><span class="n">x_coord</span><span class="o">.</span><span class="n">value</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;This is a larger pattern and the conversion between x and y deltas and RA/DEC may be slightly off.&#39;</span><span class="p">)</span>

        <span class="c1"># get alt/az</span>
        <span class="n">start_dec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_dec</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">hour_angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lst</span> <span class="o">-</span> <span class="p">(</span><span class="n">sky_pattern</span><span class="o">.</span><span class="n">x_coord</span><span class="o">/</span><span class="n">cos</span><span class="p">(</span><span class="n">start_dec</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_ra</span><span class="p">)</span> <span class="c1"># FIXME fine for small regions, but consider checking out https://docs.astropy.org/en/stable/coordinates/matchsep.html for larger regions</span>

        <span class="n">hour_angle_rad</span> <span class="o">=</span> <span class="n">hour_angle</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">dec_rad</span> <span class="o">=</span> <span class="p">(</span><span class="n">sky_pattern</span><span class="o">.</span><span class="n">y_coord</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_dec</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">lat_rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

        <span class="n">alt_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dec_rad</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">lat_rad</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec_rad</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">lat_rad</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">hour_angle_rad</span><span class="p">)</span> <span class="p">)</span>

        <span class="n">cos_az_rad</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dec_rad</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alt_rad</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">lat_rad</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alt_rad</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">lat_rad</span><span class="p">))</span>
        <span class="n">cos_az_rad</span><span class="p">[</span><span class="n">cos_az_rad</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">cos_az_rad</span><span class="p">[</span><span class="n">cos_az_rad</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="n">az_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span> <span class="n">cos_az_rad</span> <span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">hour_angle_rad</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> 
        <span class="n">az_rad</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span> <span class="o">-</span> <span class="n">az_rad</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">az_rad</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">alt_rad</span><span class="p">)</span>

    <span class="c1"># TRANSFORMATIONS</span>

    <span class="k">def</span> <span class="nf">_norm_angle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">az</span><span class="p">):</span>
        <span class="c1"># normalize azimuth values so that:</span>
        <span class="c1"># 1. starting azimuth is between 0 and 360</span>
        <span class="c1"># 2. azmiuth values are between start-180 to start+180 (centered around the start)</span>
        <span class="c1"># formula = ((value - low) % diff) + low </span>

        <span class="n">lowest_az</span> <span class="o">=</span> <span class="n">az</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">%</span><span class="mi">360</span> <span class="o">-</span> <span class="mi">180</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">az</span> <span class="o">-</span> <span class="n">lowest_az</span><span class="p">)</span><span class="o">%</span><span class="p">(</span><span class="mi">360</span><span class="p">)</span> <span class="o">+</span> <span class="n">lowest_az</span> 

    <span class="k">def</span> <span class="nf">_true_module_loc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets the (dist, theta) of the module from the boresight (not necessarily central tube)&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">module</span> <span class="o">==</span> <span class="s1">&#39;boresight&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

        <span class="c1"># passed by module identifier or instrument slot name</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">get_location</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">from_boresight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">get_slot</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">from_boresight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s1"> is not an existing module name or instrument slot&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">location_from_boresight</span><span class="p">(</span><span class="n">module</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">module</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span> <span class="nf">_transform_to_boresight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">az1</span><span class="p">,</span> <span class="n">alt1</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>

        <span class="c1"># convert everything into radians</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">alt1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">alt1</span><span class="p">)</span>
        <span class="n">az1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">az1</span><span class="p">)</span>

        <span class="c1"># getting new elevation</span>
        <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">alt_0</span><span class="p">,</span> <span class="n">alt_1</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">sin</span><span class="p">(</span><span class="n">alt_0</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">alt_0</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span> <span class="o">+</span> <span class="n">alt_0</span><span class="p">)</span> <span class="o">-</span> <span class="n">sin</span><span class="p">(</span><span class="n">alt_1</span><span class="p">)</span>

        <span class="n">alt0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">alt1</span><span class="p">))</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="n">alt1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">alt1</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">a0</span> <span class="o">=</span> <span class="n">root_scalar</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">a1</span><span class="p">),</span> <span class="n">x0</span><span class="o">=</span><span class="n">guess</span><span class="p">,</span> <span class="n">bracket</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span> <span class="n">xtol</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">9</span><span class="p">))</span><span class="o">.</span><span class="n">root</span>
                <span class="n">guess</span> <span class="o">=</span> <span class="n">a0</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;nan value at </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">alt0</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">nan</span>

            <span class="n">alt0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span> <span class="n">a0</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alt0</span><span class="p">[</span><span class="n">alt0</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;elevation has values below 0&#39;</span><span class="p">)</span>

        <span class="c1"># getting new azimuth</span>
        <span class="c1">#cos_diff_az0 = ( np.cos(alt0)*cos(dist) - np.sin(alt0)*sin(dist)*np.sin(theta + alt0) )/np.cos(alt1)</span>
        <span class="n">cos_diff_az0</span> <span class="o">=</span> <span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alt0</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alt1</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alt0</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alt1</span><span class="p">))</span>
        <span class="n">cos_diff_az0</span><span class="p">[</span><span class="n">cos_diff_az0</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">cos_diff_az0</span><span class="p">[</span><span class="n">cos_diff_az0</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">diff_az0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">cos_diff_az0</span><span class="p">)</span>

        <span class="c1"># check if diff_az is positive or negative</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">theta</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">alt0</span> <span class="o">+</span> <span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">theta</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">alt0</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">diff_az0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">diff_az0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">az0</span> <span class="o">=</span> <span class="n">az1</span> <span class="o">-</span> <span class="n">diff_az0</span>

        <span class="sd">&quot;&quot;&quot;# check is dist is dist</span>
<span class="sd">        beta = np.arcsin( np.cos(theta + alt0)*np.cos(alt0)/np.cos(alt1) )</span>
<span class="sd">        alpha = pi/2 - beta + theta + alt0</span>
<span class="sd">        dist_check = np.degrees(np.arcsin( np.cos(alt1)*np.sin(alpha)/np.cos(theta + alt0)  ))</span>
<span class="sd">        plt.plot(dist_check)&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_angle</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">az0</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">alt0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_transform_from_boresight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">az0</span><span class="p">,</span> <span class="n">alt0</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
        
        <span class="c1"># convert everything into radians</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">alt0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">alt0</span><span class="p">)</span>
        <span class="n">az0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">az0</span><span class="p">)</span>

        <span class="c1"># find elevation offset</span>
        <span class="n">alt1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alt0</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alt0</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span> <span class="o">+</span> <span class="n">alt0</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alt1</span><span class="p">[</span><span class="n">alt1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;elevation has values below 0&#39;</span><span class="p">)</span>

        <span class="c1"># find azimuth offset</span>
        <span class="n">sin_az1</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alt1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alt0</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">az0</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">az0</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span> <span class="o">+</span> <span class="n">alt0</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alt0</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">az0</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span> <span class="o">+</span> <span class="n">alt0</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">cos_az1</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alt1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alt0</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">az0</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">az0</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span> <span class="o">+</span> <span class="n">alt0</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alt0</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">az0</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span> <span class="o">+</span> <span class="n">alt0</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">az1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">sin_az1</span><span class="p">,</span> <span class="n">cos_az1</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_angle</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">az1</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">alt1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">view_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">includes_instr_offset</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ------------------------</span>
<span class="sd">        module : str or (distance, theta)</span>
<span class="sd">            string indicating a module name in the instrument e.g. &#39;SFH&#39;</span>
<span class="sd">            string indicating one of the default slots in the instrument e.g. &#39;c&#39;, &#39;i1&#39;</span>
<span class="sd">            tuple of (distance, theta) indicating module&#39;s offset from the center of the instrument</span>
<span class="sd">        includes_instr_offset : bool, default False</span>
<span class="sd">            if &quot;module&quot; parameter is a tuple of (distance, theta), this includes the instrument offset</span>

<span class="sd">        Returns</span>
<span class="sd">        -------------------------</span>
<span class="sd">        TelescopePattern </span>
<span class="sd">            a TelescopePattern object where the &quot;boresight&quot; is the path of the provided module</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">includes_instr_offset</span><span class="p">:</span>
            <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">module</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">dist</span><span class="p">,</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">module</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">module</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dist</span><span class="p">,</span> <span class="n">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_true_module_loc</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
            
        <span class="n">az1</span><span class="p">,</span> <span class="n">alt1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_from_boresight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">az_coord</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_coord</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;time_offset&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_offset</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;lst&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lst</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;az_coord&#39;</span><span class="p">:</span> <span class="n">az1</span><span class="p">,</span> <span class="s1">&#39;alt_coord&#39;</span><span class="p">:</span> <span class="n">alt1</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">TelescopePattern</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_sky_pattern</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SkyPattern</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns</span>
<span class="sd">        -------------------------</span>
<span class="sd">        SkyPattern</span>
<span class="sd">            A SkyPattern object tracing the path of the boresight.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">start_dec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> 

        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;time_offset&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_offset</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> 
            <span class="c1"># FIXME fine for small regions, but consider checking out https://docs.astropy.org/en/stable/coordinates/matchsep.html for larger regions</span>
            <span class="s1">&#39;x_coord&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra_coord</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">start_dec</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">start_dec</span><span class="p">),</span>
            <span class="s1">&#39;y_coord&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_coord</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> 
        <span class="p">}</span>

        <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;x_coord&#39;</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;This is a larger pattern and the conversion between x and y deltas and RA/DEC may be slightly off.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">SkyPattern</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># SAVING/EXTRACTING DATA</span>

    <span class="k">def</span> <span class="nf">save_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_json</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------------------------</span>
<span class="sd">        param_json : str or False</span>
<span class="sd">            path to intended file location for the parametes</span>
<span class="sd">            if None, return it as a dictionary</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        ----------------------</span>
<span class="sd">        None or dict</span>
<span class="sd">            If path_or_buf is None, returns the resulting json format as a dictionary. Otherwise returns None.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">param_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;start_datetime&#39;</span> <span class="ow">in</span> <span class="n">param_temp</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">param_temp</span><span class="p">[</span><span class="s1">&#39;start_datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_temp</span><span class="p">[</span><span class="s1">&#39;start_datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S %z&#39;</span><span class="p">)</span> 

        <span class="c1"># save param_json</span>
        <span class="k">if</span> <span class="n">param_json</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">param_temp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">param_json</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">param_temp</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_or_buf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save kinematics data of the boresight. </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------------------------</span>
<span class="sd">        path_or_buf : str or file handle, default None</span>
<span class="sd">            File path or object, if None is provided the result is returned as a dictionary.</span>
<span class="sd">        columns : sequence or str, default &#39;default&#39;</span>
<span class="sd">            Columns to write. </span>
<span class="sd">            &#39;default&#39; for [&#39;time_offset&#39;, &#39;lst&#39;, &#39;az_coord&#39;, &#39;alt_coord&#39;, &#39;az_vel&#39;, &#39;alt_vel&#39;]</span>
<span class="sd">            &#39;all&#39; for [&#39;time_offset&#39;, &#39;az_coord&#39;, &#39;alt_coord&#39;, &#39;az_vel&#39;, &#39;alt_vel&#39;, &#39;vel&#39;, &#39;az_acc&#39;, &#39;alt_acc&#39;, &#39;acc&#39;, &#39;az_jerk&#39;, &#39;alt_jerk&#39;, &#39;jerk&#39;, &#39;lst&#39;, &#39;hour_angle&#39;, &#39;para_angle&#39;, &#39;rot_angle&#39;, &#39;ra_coord&#39;, &#39;dec_coord&#39;]</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        ----------------------</span>
<span class="sd">        None or dict</span>
<span class="sd">            If path_or_buf is None, returns the resulting json format as a dictionary. Otherwise returns None.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># replace str options</span>
        <span class="k">if</span> <span class="n">columns</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;time_offset&#39;</span><span class="p">,</span> <span class="s1">&#39;lst&#39;</span><span class="p">,</span> <span class="s1">&#39;az_coord&#39;</span><span class="p">,</span> <span class="s1">&#39;alt_coord&#39;</span><span class="p">,</span> <span class="s1">&#39;az_vel&#39;</span><span class="p">,</span> <span class="s1">&#39;alt_vel&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">columns</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;time_offset&#39;</span><span class="p">,</span> <span class="s1">&#39;az_coord&#39;</span><span class="p">,</span> <span class="s1">&#39;alt_coord&#39;</span><span class="p">,</span> <span class="s1">&#39;az_vel&#39;</span><span class="p">,</span> <span class="s1">&#39;alt_vel&#39;</span><span class="p">,</span> <span class="s1">&#39;vel&#39;</span><span class="p">,</span> <span class="s1">&#39;az_acc&#39;</span><span class="p">,</span> <span class="s1">&#39;alt_acc&#39;</span><span class="p">,</span> <span class="s1">&#39;acc&#39;</span><span class="p">,</span> <span class="s1">&#39;az_jerk&#39;</span><span class="p">,</span> <span class="s1">&#39;alt_jerk&#39;</span><span class="p">,</span> <span class="s1">&#39;jerk&#39;</span><span class="p">,</span> <span class="s1">&#39;lst&#39;</span><span class="p">,</span> <span class="s1">&#39;hour_angle&#39;</span><span class="p">,</span> <span class="s1">&#39;para_angle&#39;</span><span class="p">,</span> <span class="s1">&#39;rot_angle&#39;</span><span class="p">,</span> <span class="s1">&#39;ra_coord&#39;</span><span class="p">,</span> <span class="s1">&#39;dec_coord&#39;</span><span class="p">]</span>
        
        <span class="c1"># generate required data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;time_offset&#39;</span><span class="p">,</span> <span class="s1">&#39;lst&#39;</span><span class="p">,</span> <span class="s1">&#39;az_coord&#39;</span><span class="p">,</span> <span class="s1">&#39;alt_coord&#39;</span><span class="p">]:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        
        <span class="c1"># save data file </span>
        <span class="k">if</span> <span class="n">path_or_buf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">path_or_buf</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># ATTRIBUTES</span>

    <span class="c1"># data : time_offset, lst, alt_coord, az_coord</span>
    <span class="c1"># param</span>
    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_unit</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="ow">is</span> <span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_param_unit</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_unit</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;attribtue </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s1"> not found&#39;</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">scan_duration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_offset</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_interval</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sample_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_interval</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dec_coord</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lat_rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">alt_coord_rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_coord</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">az_coord_rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">az_coord</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

        <span class="n">dec_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span> <span class="n">sin</span><span class="p">(</span><span class="n">lat_rad</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alt_coord_rad</span><span class="p">)</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">lat_rad</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alt_coord_rad</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">az_coord_rad</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">dec_rad</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hour_angle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lat_rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">alt_coord_rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_coord</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">az_coord_rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">az_coord</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">dec_rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_coord</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

        <span class="n">hrang_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alt_coord_rad</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dec_rad</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">lat_rad</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec_rad</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">lat_rad</span><span class="p">))</span> <span class="p">)</span>
        
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">az_coord_rad</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">hrang_rad</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span> <span class="o">-</span> <span class="n">hrang_rad</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">hrang_rad</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ra_coord</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_angle</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">lst</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">hour_angle</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">para_angle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dec_rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_coord</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">hour_angle_rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hour_angle</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">lat_rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

        <span class="n">para_angle_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span> 
            <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">hour_angle_rad</span><span class="p">),</span> 
            <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec_rad</span><span class="p">)</span><span class="o">*</span><span class="n">tan</span><span class="p">(</span><span class="n">lat_rad</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dec_rad</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">hour_angle_rad</span><span class="p">)</span> 
        <span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_angle</span><span class="p">(</span><span class="n">para_angle_deg</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rot_angle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_angle</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">para_angle</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_coord</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">az_vel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_central_diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">az_coord</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_interval</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">alt_vel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_central_diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alt_coord</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_interval</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">az_vel</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_vel</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">az_acc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_central_diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">az_vel</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_interval</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">alt_acc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_central_diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alt_vel</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_interval</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">acc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">az_acc</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_acc</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">az_jerk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_central_diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">az_acc</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_interval</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="o">/</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">alt_jerk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_central_diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alt_acc</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_interval</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="o">/</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">jerk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">az_jerk</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_jerk</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">mapping</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Introduction</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Kristin Wu, Doug Johnstone, Erik Rosolowsky.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>